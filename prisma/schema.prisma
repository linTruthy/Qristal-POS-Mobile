generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ------------------------------------------------------
// 1. AUTH & STAFF
// ------------------------------------------------------
enum Role {
  OWNER
  MANAGER
  CASHIER
  WAITER
  KITCHEN
}

enum ProductionArea {
  KITCHEN
  BARISTA
  BAR
  RETAIL
  OTHER
}

model User {
  id       String  @id @default(uuid())
  pin      String  @unique // Hashed PIN for terminal login
  role     Role    @default(WAITER)
  fullName String  @map("full_name")
  branchId String  @map("branch_id") // Ready for Phase 3 (Multi-branch)
  isActive Boolean @default(true) @map("is_active")

  // Relations
  orders    Order[]
  shifts    Shift[]
  auditLogs AuditLog[]

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at") // Soft delete

  @@map("users")
}

// ------------------------------------------------------
// 2. MENU & PRODUCTS (Server is source of truth)
// ------------------------------------------------------
model Category {
  id        String  @id @default(uuid())
  branchId     String    @default("BRANCH-01") @map("branch_id")
  name      String
  colorHex  String? @map("color_hex") // For the POS UI (e.g., #FF5733)
  sortOrder Int     @default(0) @map("sort_order")

  products Product[]

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at") // Used by terminal to detect changes
  deletedAt DateTime? @map("deleted_at")

  @@map("categories")
}

model Product {
  id          String  @id @default(uuid())
  categoryId  String  @map("category_id")
  name        String
  price       Decimal @db.Decimal(10, 2)
  isAvailable Boolean @default(true) @map("is_available")
  productionArea ProductionArea @default(KITCHEN) @map("production_area")
  sortOrder      Int     @default(0) @map("sort_order")

  category   Category    @relation(fields: [categoryId], references: [id])
  orderItems OrderItem[]
  productModifierGroups ProductModifierGroup[]
  productSides          ProductSide[]

  branchId     String    @default("BRANCH-01") @map("branch_id")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at") // The sync engine monitors this field heavily!
  deletedAt DateTime? @map("deleted_at")

  recipe RecipeIngredient[]

  @@map("products")
}

// ------------------------------------------------------
// 3. ORDERS (Terminals are source of truth, pushed to server)
// ------------------------------------------------------
enum OrderStatus {
  OPEN
  KITCHEN
  SERVED
  CLOSED
  VOIDED
}

model Order {
  id            String      @id @default(uuid()) // Terminals generate this UUID
  branchId      String      @default("BRANCH-01") @map("branch_id")
  receiptNumber String      @map("receipt_number") // e.g., ORD-0001
  userId        String      @map("user_id") // Waiter who took the order
  tableId       String?     @map("table_id") // Nullable for takeaway
  shiftId       String?     @map("shift_id")
  totalAmount   Decimal     @map("total_amount") @db.Decimal(10, 2)
  status        OrderStatus @default(OPEN)

  user     User        @relation(fields: [userId], references: [id])
  items    OrderItem[]
  shift    Shift?      @relation(fields: [shiftId], references: [id])
  payments Payment[]

  table SeatingTable? @relation(fields: [tableId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("orders")
}

model OrderItem {
  id                 String  @id @default(uuid())
  orderId            String  @map("order_id")
  productId          String  @map("product_id")
  quantity           Int
  priceAtTimeOfOrder Decimal @map("price_at_time_of_order") @db.Decimal(10, 2) // Financial integrity
  routeTo            String? @map("route_to")
  notes              String? // e.g. "Extra spicy"

  order      Order                @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product    Product              @relation(fields: [productId], references: [id])
  modifiers  OrderItemModifier[]
  sides      OrderItemSide[]

  @@map("order_items")
}

model OrderItemModifier {
  id          String  @id @default(uuid())
  orderItemId String  @map("order_item_id")
  name        String
  priceDelta  Decimal @default(0) @map("price_delta") @db.Decimal(10, 2)
  routeTo     String? @map("route_to")

  orderItem OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  @@map("order_item_modifiers")
}

model OrderItemSide {
  id          String  @id @default(uuid())
  orderItemId String  @map("order_item_id")
  name        String
  quantity    Int     @default(1)
  priceDelta  Decimal @default(0) @map("price_delta") @db.Decimal(10, 2)
  routeTo     String? @map("route_to")

  orderItem OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  @@map("order_item_sides")
}

model ModifierGroup {
  id        String @id @default(uuid())
  branchId  String @default("BRANCH-01") @map("branch_id")
  name      String
  minSelect Int    @default(0) @map("min_select")
  maxSelect Int?   @map("max_select")
  isRequired Boolean @default(false) @map("is_required")
  sortOrder Int    @default(0) @map("sort_order")

  modifiers Modifier[]
  products  ProductModifierGroup[]

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@unique([branchId, name])
  @@map("modifier_groups")
}

model Modifier {
  id              String  @id @default(uuid())
  modifierGroupId String  @map("modifier_group_id")
  name            String
  priceDelta      Decimal @default(0) @map("price_delta") @db.Decimal(10, 2)
  productionArea  ProductionArea @default(KITCHEN) @map("production_area")
  isAvailable     Boolean @default(true) @map("is_available")
  sortOrder       Int     @default(0) @map("sort_order")

  modifierGroup ModifierGroup @relation(fields: [modifierGroupId], references: [id], onDelete: Cascade)

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@unique([modifierGroupId, name])
  @@map("modifiers")
}
model Side {
  id            String  @id @default(uuid())
  branchId      String  @default("BRANCH-01") @map("branch_id")
  name          String
  priceDelta    Decimal @default(0) @map("price_delta") @db.Decimal(10, 2)
  productionArea ProductionArea @default(KITCHEN) @map("production_area")
  isAvailable   Boolean @default(true) @map("is_available")
  sortOrder     Int     @default(0) @map("sort_order")

  products ProductSide[]

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@unique([branchId, name])
  @@map("sides_library")
}

model ProductModifierGroup {
  id              String @id @default(uuid())
  productId       String @map("product_id")
  modifierGroupId String @map("modifier_group_id")
  sortOrder       Int    @default(0) @map("sort_order")

  product       Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  modifierGroup ModifierGroup @relation(fields: [modifierGroupId], references: [id], onDelete: Cascade)

  @@unique([productId, modifierGroupId])
  @@map("product_modifier_groups")
}

model ProductSide {
  id        String @id @default(uuid())
  productId String @map("product_id")
  sideId    String @map("side_id")
  sortOrder Int    @default(0) @map("sort_order")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  side    Side    @relation(fields: [sideId], references: [id], onDelete: Cascade)

  @@unique([productId, sideId])
  @@map("product_sides")
}
enum PaymentMethod {
  CASH
  CARD
  MOBILE_MONEY
  OTHER
}

enum AuditAction {
  VOID
  DISCOUNT
  CASH_IN
  CASH_OUT
}

enum SyncDirection {
  PULL
  PUSH
}

enum SyncStatus {
  SUCCESS
  FAILED
}

model Payment {
  id        String        @id @default(uuid())
  orderId   String        @map("order_id")
  shiftId   String?       @map("shift_id")
  method    PaymentMethod
  amount    Decimal       @db.Decimal(10, 2)
  reference String? // For Mobile Money Ref / Card Auth Code
  createdAt DateTime      @default(now()) @map("created_at")

  order Order @relation(fields: [orderId], references: [id])
  shift Shift? @relation(fields: [shiftId], references: [id])

  @@map("payments")
}

model SeatingTable {
  id       String @id @default(uuid())
  branchId     String    @default("BRANCH-01") @map("branch_id")
  name     String // e.g., "T-1", "Bar-2"
  status   String @default("FREE") // FREE, OCCUPIED, RESERVED
  capacity Int    @default(4)
  floor    String @default("Main") // Main, Terrace, VIP

  // Coordinates for future Drag-n-Drop UI
  x Int @default(0)
  y Int @default(0)

  orders Order[]

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@map("seating_tables")
}

// ------------------------------------------------------
// 4. INVENTORY & RECIPES
// ------------------------------------------------------

model InventoryItem {
  id            String  @id @default(uuid())
  branchId     String    @default("BRANCH-01") @map("branch_id")
  name          String // e.g., "Coffee Beans", "Milk", "Burger Bun"
  sku           String?
  unitOfMeasure String // e.g., "Kg", "Liters", "Pieces", "Grams"
  currentStock  Decimal @default(0) @db.Decimal(10, 4)
  minimumStock  Decimal @default(0) @db.Decimal(10, 4) // For low stock alerts
  costPerUnit   Decimal @default(0) @db.Decimal(10, 2)

  recipeIngredients RecipeIngredient[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("inventory_items")
}

// A Recipe links a Product (what you sell) to InventoryItems (what you use)
model RecipeIngredient {
  id              String @id @default(uuid())
  productId       String @map("product_id")
  inventoryItemId String @map("inventory_item_id")

  // How much of the inventory item is used to make ONE of the product
  // e.g., 1 Cappuccino uses 15 (amount) Grams (from InventoryItem unit) of Coffee Beans
  amount Decimal @db.Decimal(10, 4)

  product       Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Restrict)

  @@map("recipe_ingredients")
}

model Shift {
  id          String    @id @default(uuid())
  branchId     String    @default("BRANCH-01") @map("branch_id")
  userId      String    @map("user_id")
  openingTime DateTime  @default(now()) @map("opening_time")
  closingTime DateTime? @map("closing_time")

  startingCash Decimal  @default(0) @map("starting_cash") @db.Decimal(10, 2)
  expectedCash Decimal? @map("expected_cash") @db.Decimal(10, 2)
  actualCash   Decimal? @map("actual_cash") @db.Decimal(10, 2)

  notes String?

  user     User      @relation(fields: [userId], references: [id])
  orders   Order[]   // A shift has many orders
  payments Payment[]

  updatedAt DateTime  @updatedAt @map("updated_at")

  @@map("shifts")
}

model AuditLog {
  id        String      @id @default(uuid())
  branchId  String      @default("BRANCH-01") @map("branch_id")
  userId    String?     @map("user_id")
  action    AuditAction
  orderId   String?     @map("order_id")
  metadata  Json?
  createdAt DateTime    @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}

model SyncLog {
  id            String        @id @default(uuid())
  branchId      String        @default("BRANCH-01") @map("branch_id")
  direction     SyncDirection
  status        SyncStatus
  startedAt     DateTime      @default(now()) @map("started_at")
  finishedAt    DateTime?     @map("finished_at")
  recordsPushed Int           @default(0) @map("records_pushed")
  recordsPulled Int           @default(0) @map("records_pulled")
  errorMessage  String?       @map("error_message")

  @@map("sync_logs")
}
