generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ------------------------------------------------------
// 1. AUTH & STAFF
// ------------------------------------------------------
enum Role {
  OWNER
  MANAGER
  CASHIER
  WAITER
  KITCHEN
}

model User {
  id           String    @id @default(uuid())
  pin          String    @unique // Hashed PIN for terminal login
  role         Role      @default(WAITER)
  fullName     String    @map("full_name")
  branchId     String    @map("branch_id") // Ready for Phase 3 (Multi-branch)
  isActive     Boolean   @default(true) @map("is_active")
  
  // Relations
  orders       Order[]
  
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  deletedAt    DateTime? @map("deleted_at") // Soft delete

  @@map("users")
}

// ------------------------------------------------------
// 2. MENU & PRODUCTS (Server is source of truth)
// ------------------------------------------------------
model Category {
  id           String    @id @default(uuid())
  name         String
  colorHex     String?   @map("color_hex") // For the POS UI (e.g., #FF5733)
  sortOrder    Int       @default(0) @map("sort_order")
  
  products     Product[]

  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at") // Used by terminal to detect changes
  deletedAt    DateTime? @map("deleted_at")

  @@map("categories")
}

model Product {
  id           String    @id @default(uuid())
  categoryId   String    @map("category_id")
  name         String
  price        Decimal   @db.Decimal(10, 2)
  isAvailable  Boolean   @default(true) @map("is_available")

  category     Category  @relation(fields: [categoryId], references: [id])
  orderItems   OrderItem[]

  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at") // The sync engine monitors this field heavily!
  deletedAt    DateTime? @map("deleted_at")

  recipe          RecipeIngredient[]

  @@map("products")
}

// ------------------------------------------------------
// 3. ORDERS (Terminals are source of truth, pushed to server)
// ------------------------------------------------------
enum OrderStatus {
  OPEN
  KITCHEN
  SERVED
  CLOSED
  VOIDED
}

model Order {
  id            String      @id @default(uuid()) // Terminals generate this UUID
  receiptNumber String      @map("receipt_number") // e.g., ORD-0001
  userId        String      @map("user_id") // Waiter who took the order
  tableId       String?     @map("table_id") // Nullable for takeaway
  totalAmount   Decimal     @db.Decimal(10, 2) @map("total_amount")
  status        OrderStatus @default(OPEN)
  
  user          User        @relation(fields: [userId], references: [id])
  items         OrderItem[]

  payments      Payment[]

  table         SeatingTable? @relation(fields: [tableId], references: [id])

  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  @@map("orders")
}

model OrderItem {
  id                  String   @id @default(uuid())
  orderId             String   @map("order_id")
  productId           String   @map("product_id")
  quantity            Int
  priceAtTimeOfOrder  Decimal  @db.Decimal(10, 2) @map("price_at_time_of_order") // Financial integrity
  notes               String?  // e.g. "Extra spicy"
  
  order               Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product             Product  @relation(fields: [productId], references: [id])

  @@map("order_items")
}

enum PaymentMethod {
  CASH
  CARD
  MOBILE_MONEY
  OTHER
}

model Payment {
  id            String        @id @default(uuid())
  orderId       String        @map("order_id")
  method        PaymentMethod
  amount        Decimal       @db.Decimal(10, 2)
  reference     String?       // For Mobile Money Ref / Card Auth Code
  createdAt     DateTime      @default(now()) @map("created_at")

  order         Order         @relation(fields: [orderId], references: [id])

  @@map("payments")
}

model SeatingTable {
  id        String   @id @default(uuid())
  name      String   // e.g., "T-1", "Bar-2"
  status    String   @default("FREE") // FREE, OCCUPIED, RESERVED
  capacity  Int      @default(4)
  floor     String   @default("Main") // Main, Terrace, VIP
  
  // Coordinates for future Drag-n-Drop UI
  x         Int      @default(0) 
  y         Int      @default(0)

  orders    Order[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@map("seating_tables")
}

// ------------------------------------------------------
// 4. INVENTORY & RECIPES
// ------------------------------------------------------

model InventoryItem {
  id              String   @id @default(uuid())
  name            String   // e.g., "Coffee Beans", "Milk", "Burger Bun"
  sku             String?  @unique
  unitOfMeasure   String   // e.g., "Kg", "Liters", "Pieces", "Grams"
  currentStock    Decimal  @default(0) @db.Decimal(10, 4)
  minimumStock    Decimal  @default(0) @db.Decimal(10, 4) // For low stock alerts
  costPerUnit     Decimal  @default(0) @db.Decimal(10, 2)
  
  recipeIngredients RecipeIngredient[]

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("inventory_items")
}

// A Recipe links a Product (what you sell) to InventoryItems (what you use)
model RecipeIngredient {
  id              String   @id @default(uuid())
  productId       String   @map("product_id")
  inventoryItemId String   @map("inventory_item_id")
  
  // How much of the inventory item is used to make ONE of the product
  // e.g., 1 Cappuccino uses 15 (amount) Grams (from InventoryItem unit) of Coffee Beans
  amount          Decimal  @db.Decimal(10, 4) 

  product         Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Restrict)

  @@map("recipe_ingredients")
}